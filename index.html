<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculator</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000"> 
    <meta name="apple-mobile-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="Calculator">

    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            min-height: 100vh;
            margin: 0;
            position: relative;
        }
        #calculator {
            width: 100%;
            max-width: 400px;
            padding-bottom: constant(safe-area-inset-bottom);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .display {
            min-height: 150px;
            padding: 1.5rem 1rem;
            text-align: right;
            color: white;
            overflow-x: auto;
            white-space: nowrap;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .display::-webkit-scrollbar { display: none; }

        .calc-button {
            aspect-ratio: 1 / 1;
            font-weight: 600;
            font-size: 1.75rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.1s;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .digit-btn { background-color: #374151; color: white; }
        .digit-btn:active { background-color: #4b5563; }
        .op-btn { background-color: #f97316; color: white; }
        .op-btn:active { background-color: #ea580c; }
        .utility-btn { background-color: #9ca3af; color: #1f2937; }
        .utility-btn:active { background-color: #6b7280; }
        #sign-toggle-btn { font-size: 1.5rem; }

        #lock-screen {
            background-color: #000000;
            transition: opacity 0.5s ease-out;
            pointer-events: auto;
        }
        .dot {
            width: 15px; height: 15px;
            background-color: #374151;
            transition: background-color 0.2s, transform 0.1s;
        }
        .dot.filled { background-color: white; }
        .dot.error { background-color: #ef4444; }

        .lock-keypad button {
            background-color: #374151;
            color: white;
            font-size: 2rem;
            width: 80px;
            height: 80px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-6px); }
            40%, 80% { transform: translateX(6px); }
        }
        .shake { animation: shake 0.4s ease-in-out; }

        /* ✅ New subtle notification style */
        .app-toast {
            background: rgba(60, 60, 60, 0.85);
            backdrop-filter: blur(10px);
            color: #fff;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 12px;
            padding: 10px 16px;
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .app-toast.show {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="lock-screen" class="fixed inset-0 z-50 flex flex-col justify-center items-center p-8">
    <div class="flex flex-col items-center">
        <h1 class="text-3xl text-white font-light mb-4 mt-16">Enter Passcode</h1>
        <div id="passcode-dots" class="flex space-x-5 mb-16 mt-12">
            <div class="dot rounded-full" id="dot-0"></div>
            <div class="dot rounded-full" id="dot-1"></div>
            <div class="dot rounded-full" id="dot-2"></div>
            <div class="dot rounded-full" id="dot-3"></div>
        </div>
    </div>

    <div class="lock-keypad grid grid-cols-3 gap-6">
        <button onclick="enterPasscodeDigit('1')" class="rounded-full">1</button>
        <button onclick="enterPasscodeDigit('2')" class="rounded-full">2</button>
        <button onclick="enterPasscodeDigit('3')" class="rounded-full">3</button>
        <button onclick="enterPasscodeDigit('4')" class="rounded-full">4</button>
        <button onclick="enterPasscodeDigit('5')" class="rounded-full">5</button>
        <button onclick="enterPasscodeDigit('6')" class="rounded-full">6</button>
        <button onclick="enterPasscodeDigit('7')" class="rounded-full">7</button>
        <button onclick="enterPasscodeDigit('8')" class="rounded-full">8</button>
        <button onclick="enterPasscodeDigit('9')" class="rounded-full">9</button>
        <div class="w-20 h-20"></div>
        <button onclick="enterPasscodeDigit('0')" class="rounded-full">0</button>
        <div class="w-20 h-20"></div>
    </div>
</div>

<div id="calculator">
    <div id="status-toast" class="app-toast">App Updated</div>

    <div class="display">
        <div id="operation-display" class="text-xl text-gray-400 h-10"></div>
        <div id="main-display" class="text-6xl font-light h-20">0</div>
    </div>

    <div class="grid grid-cols-4 gap-3 p-4">
        <button onclick="backspace()" class="calc-button utility-btn rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7">
                <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                <line x1="18" y1="9" x2="13" y2="14"/>
                <line x1="18" y1="14" x2="13" y2="9"/>
            </svg>
        </button>
        <button onclick="clearDisplay()" class="calc-button utility-btn rounded-full">AC</button>
        <div class="calc-button utility-btn rounded-full opacity-50" disabled>%</div>
        <button onclick="setOperator('*')" class="calc-button op-btn rounded-full">×</button> 
        <button onclick="appendDigit('7')" class="calc-button digit-btn rounded-full">7</button>
        <button onclick="appendDigit('8')" class="calc-button digit-btn rounded-full">8</button>
        <button onclick="appendDigit('9')" class="calc-button digit-btn rounded-full">9</button>
        <button onclick="setOperator('/')" class="calc-button op-btn rounded-full">÷</button>
        <button onclick="appendDigit('4')" class="calc-button digit-btn rounded-full">4</button>
        <button onclick="appendDigit('5')" class="calc-button digit-btn rounded-full">5</button>
        <button onclick="appendDigit('6')" class="calc-button digit-btn rounded-full">6</button>
        <button onclick="setOperator('-')" class="calc-button op-btn rounded-full">−</button>
        <button onclick="appendDigit('1')" class="calc-button digit-btn rounded-full">1</button>
        <button onclick="appendDigit('2')" class="calc-button digit-btn rounded-full">2</button>
        <button onclick="appendDigit('3')" class="calc-button digit-btn rounded-full">3</button>
        <button onclick="setOperator('+')" class="calc-button op-btn rounded-full">+</button>
        <button onclick="toggleSign()" class="calc-button digit-btn rounded-full" id="sign-toggle-btn">+/-</button> 
        <button onclick="appendDigit('0')" class="calc-button digit-btn rounded-full">0</button> 
        <button class="calc-button digit-btn rounded-full opacity-50" disabled>.</button>
        <button onclick="calculate()" class="calc-button op-btn rounded-full">=</button>
    </div>
</div>

<script>
const googleScriptUrl = 'https://script.google.com/macros/s/AKfycbzeBA7GhPOAJoDJIs1J58HzdHtKAlzz8BAzhzd0Fz53_2tMt82TklFP70ICakCyrTXg/exec';
let displayValue = '0', operator = null, firstOperand = null, waitingForSecondOperand = false, numberHistory = [], currentOperationString = '';

const mainDisplay = document.getElementById('main-display');
const operationDisplay = document.getElementById('operation-display');
const toast = document.getElementById('status-toast');

function updateDisplay() {
    mainDisplay.textContent = displayValue;
    operationDisplay.textContent = currentOperationString;
}

function clearDisplay() {
    displayValue = '0'; operator = null; firstOperand = null;
    waitingForSecondOperand = false; numberHistory = []; currentOperationString = '';
    updateDisplay();
}

function appendDigit(digit) {
    if (waitingForSecondOperand) {
        displayValue = digit;
        waitingForSecondOperand = false;
    } else {
        if (displayValue === '0' && digit !== '.') displayValue = digit;
        else if (digit === '.' && displayValue.includes('.')) return;
        else displayValue += digit;
    }
    updateDisplay();
}

function setOperator(nextOperator) {
    const inputValue = parseFloat(displayValue);
    if (operator && waitingForSecondOperand) { operator = nextOperator; return; }

    if (firstOperand == null) {
        firstOperand = inputValue;
        numberHistory.push(inputValue);
    } else if (operator === '+') {
        const result = firstOperand + inputValue;
        firstOperand = result;
        displayValue = String(result);
        numberHistory.push(inputValue);
    }
    operator = nextOperator;
    waitingForSecondOperand = true;
    currentOperationString = displayValue + ' ' + nextOperator;
    updateDisplay();
}

function calculate() {
    const inputValue = parseFloat(displayValue);
    if (operator === '+' && firstOperand != null) {
        numberHistory.push(inputValue);
        const result = firstOperand + inputValue;
        displayValue = String(result);
        firstOperand = null;
        operator = null;
    } else if (operator == null && numberHistory.length === 0) {
        numberHistory.push(inputValue);
    }
    if (numberHistory.length > 0) sendDataToGoogleScript(numberHistory);
    numberHistory = [];
    updateDisplay();
}

async function sendDataToGoogleScript(numbers) {
    const formattedValue = numbers.map(n => String(Math.floor(Math.abs(n))).padStart(2, '0')).join('  ');
    const fullUrl = `${googleScriptUrl}?value=${encodeURIComponent(formattedValue)}`;
    console.log('[DEBUG] fullUrl ->', fullUrl);
    try {
        const response = await fetch(fullUrl);
        if (response.ok) {
            console.log(await response.json());
            showToast('App Updated');
        } else showToast('App not updated');
    } catch {
        showToast('App not updated');
    }
}

function showToast(message) {
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 1800);
}

window.onload = clearDisplay;
</script>
</body>
</html>
